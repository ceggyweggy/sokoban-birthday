#include <iostream>
#include <unistd.h>
#include <termios.h>
#include <stdlib.h>
using namespace std;

char ggetch() {
        char buf = 0;
        struct termios old = {0};
        if (tcgetattr(0, &old) < 0)
                perror("tcsetattr()");
        old.c_lflag &= ~ICANON;
        old.c_lflag &= ~ECHO;
        old.c_cc[VMIN] = 1;
        old.c_cc[VTIME] = 0;
        if (tcsetattr(0, TCSANOW, &old) < 0)
                perror("tcsetattr ICANON");
        if (read(0, &buf, 1) < 0)
                perror ("read()");
        old.c_lflag |= ICANON;
        old.c_lflag |= ECHO;
        if (tcsetattr(0, TCSADRAIN, &old) < 0)
                perror ("tcsetattr ~ICANON");
        return (buf);
}

char cur_level[40][40];
int x_length, y_length;
int final_level = 16;

char level1[12][16] = {{'-','-','-','-','-','-','-','-',' ','-','-','-','-','-','-'}, {'|','<','|','>','.','.','.','-','-','-','.','.','.','.','|'}, {'|','^','|','-','.','`','`','.','.','.','.','`','.','.','|'}, {'|','^','|','|','.','.','`','`','|','.','`','.','`','.','|'}, {'|','^','|','|','.','.','.','.','|','.','.','.','.','.','|'}, {'|','^','|','-','-','-','-','-','-','`','-','-','-','-','|'}, {'|','^','|',' ',' ',' ',' ','|','.','.','.','.','.','.','|'}, {'|','^','-','-','-','-','-','-','.','.','.','.','.','.','|'}, {'|','.','.','^','^','^','^','`','`','`','`','.','.','.','|'}, {'|','.','.','-','-','-','-','-','.','.','.','.','.','.','|'}, {'-','-','-','-',' ',' ',' ','-','-','-','-','-','-','-','-'}};

char level2[14][15] = {{'-','-','-','-','-','-',' ',' ','-','-','-','-','-',' '}, {'|','.','.','.','.','|',' ',' ','|','.','.','.','|',' '}, {'|','.','`','.','.','-','-','-','-','.','`','.','|',' '}, {'|','.','`','.','.','.','.','.','.','`','.','.','|',' '}, {'|','.','.','-','-','-','>','-','-','-','`','.','|',' '}, {'|','-','-','-','-','-','-','-','-','-','.','-','-','-',' '}, {'|','.','.','^','^','^','<','|','.','.','.','.','.','|',' '}, {'|','.','.','-','-','-','-','|','`','.','.','.','.','|',' '}, {'-','-','^','|',' ',' ',' ','|','.','`','.','.','.','|'}, {' ','|','^','-','-','-','-','-','.','`','.','.','.','|'}, {' ','|','.','.','^','^','^','^','`','.','`','.','.','|'}, {' ','|','.','.','-','-','-','-','-','-','-','-','-','-'}, {' ','-','-','-','-',' ',' ',' ',' ',' ',' ',' ',' ',' '}};

char level3[15][27] = {{' ','-','-','-','-',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','-','-','-','-','-','-','-','-','-','-','-'}, {'-','-','.','>','-','-','-','-','-','-','-','-',' ',' ',' ','|','.','.','.','.','.','.','.','.','.','|'}, {'|','.','.','.','.','.','.','.','.','.','.','|',' ',' ',' ','|','.','.','.','.','.','.','.','.','.','|'}, {'|','.','`','-','-','-','-','-','`','-','.','|',' ',' ',' ','|','.','.','.','.','.','.','.','.','.','|'}, {'|','.','.','|','.','.','.','|','.','`','.','|',' ',' ',' ','|','.','.','.','.','<','.','.','.','.','|'}, {'|','.','`','.','`','.','.','.','.','`','-','|',' ',' ',' ','|','.','.','.','.','.','.','.','.','.','|'}, {'|','.','`','.','.','`','.','.','|','.','.','|',' ',' ',' ','|','.','.','.','.','.','.','.','.','.','|'}, {'|','.','-','-','-','-','`','.','-','-','.','|',' ',' ',' ','|','.','.','.','.','.','.','.','.','.','|'}, {'|','.','.','`','.','.','.','`','.','|','.','-','-',' ',' ','|','.','.','.','.','.','.','.','.','.','|'}, {'|','.','-','-','-','`','-','.','.','.','`','.','-','-','-','-','-','-','-','-','-','-','-','-','+','|'}, {'|','.','.','.','|','.','.','`','-','.','`','.','^','^','^','^','^','^','^','^','^','^','^','^','.','|'}, {'|','.','.','`','.','.','.','.','.','.','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-'}, {'-','-','-','-','-','.','.','|','.','.','|', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '}, {' ',' ',' ',' ','-','-','-','-','-','-','-', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '}};

char level4[13][30] = {{'-','-','-','-','-','-','-','-','-','-','-',' ',' ',' ',' ',' ',' ',' ','-','-','-','-','-','-','-','-','-','-','-'}, {'|','.','.','.','.','|','.','.','.','.','-','-','-',' ',' ',' ',' ',' ','|','.','.','.','.','.','.','.','.','.','|'}, {'|','.','.','`','`','|','`','`','.','.','.','>','|',' ',' ',' ',' ',' ','|','.','.','.','.','.','.','.','.','.','|'}, {'|','.','.','.','.','.','`','.','.','.','-','-','-',' ',' ',' ',' ',' ','|','.','.','.','.','.','.','.','.','.','|'}, {'|','.','.','.','.','|','.','.','.','.','|',' ',' ',' ',' ',' ',' ',' ','|','.','.','.','.','<','.','.','.','.','|'}, {'|','-','.','-','-','-','-','-','-','-','-','-',' ',' ',' ',' ',' ',' ','|','.','.','.','.','.','.','.','.','.','|'}, {'|','.','.','`','.','|','.','.','.','.','.','|',' ',' ',' ',' ',' ',' ','|','.','.','.','.','.','.','.','.','.','|'}, {'|','.','`','`','.','|','`','.','`','.','`','|',' ',' ',' ',' ',' ',' ','|','.','.','.','.','.','.','.','.','.','|'}, {'|','.','.','`','.','.','.','.','.','`','.','|',' ',' ',' ',' ',' ',' ','|','.','.','.','.','.','.','.','.','.','|'}, {'|','.','`','`','`','|','`','.','.','`','.','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','+','|'}, {'|','.','.','.','.','|','.','.','`','.','`','.','^','^','^','^','^','^','^','^','^','^','^','^','^','^','^','.','|'}, {'-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-'}};

char level5[13][21] = {{'-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-'}, {'|','.','.','.','.','.','.','.','.','|','.','.','.','|','.','.','.','.','.','|'}, {'|','.','`','`','.','.','-','`','`','|','.','-','.','|','.','.','.','.','.','|'}, {'|','.','.','|','.','`','.','`','.','|','`','`','.','|','.','.','.','.','.','|'}, {'|','-','.','|','.','.','-','.','.','|','.','-','.','|','.','.','<','.','.','|'}, {'|','.','.','.','-','-','.','.','.','.','.','.','.','|','.','.','.','.','.','|'}, {'|','.','.','.','|','.','`','.','-','.','.','.','-','|','.','.','.','.','.','|'}, {'|','.','`','.','|','`','.','|','.','.','.','-','-','|','.','.','.','.','.','|'}, {'|','-','`','.','|','.','.','-','-','-','-','-','-','-','-','-','-','-','+','|'}, {'|','.','.','`','.','.','.','.','^','^','^','^','^','^','^','^','^','^','.','|'}, {'|','.','.','.','|','.','>','-','-','-','-','-','-','-','-','-','-','-','-','-'}, {'-','-','-','-','-','-','-','-', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' ', ' '}};

char level6[19][27] = {{'-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-'}, {'|','>','.','.','.','.','.','.','^','^','^','^','^','^','^','^','^','^','^','^','^','^','^','^','.','|'}, {'|','.','.','.','.','.','.','.','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','-','.','|'}, {'-','-','-','-','-','-','-','.','-','-','-','-','-','-',' ',' ',' ',' ',' ',' ',' ',' ',' ','|','.','|'}, {' ','|','.','.','.','.','.','.','.','.','.','.','.','|',' ',' ',' ',' ',' ',' ',' ',' ',' ','|','.','|'}, {' ','|','.','`','.','`','.','`','.','`','.','`','.','|',' ',' ',' ',' ',' ',' ',' ',' ',' ','|','.','|'}, {'-','-','-','-','-','-','-','-','.','-','-','-','-','|',' ',' ',' ',' ',' ',' ',' ',' ',' ','|','.','|'}, {'|','.','.','.','`','.','`','.','.','`','.','`','.','|',' ',' ',' ',' ',' ',' ',' ',' ',' ','|','.','|'}, {'|','.','.','.','`','.','.','.','.','.','.','.','.','|',' ',' ',' ',' ',' ',' ',' ',' ',' ','|','.','|'}, {'-','-','-','-','-','.','-','-','-','-','-','-','-','-',' ',' ',' ','-','-','-','-','-','-','|','.','|'}, {' ','|','.','.','`','.','`','.','`','.','.','.','|',' ',' ','-','-','|','.','.','.','.','.','|','.','|'}, {' ','|','.','.','.','.','.','`','.','.','.','.','|',' ',' ','|','.','+','.','.','.','.','.','|','.','|'}, {' ','|','.','`','.','`','.','.','.','`','.','-','-',' ',' ','|','-','|','.','.','.','.','.','|','.','|'}, {'-','-','-','-','-','-','-','.','-','-','-','-',' ',' ',' ','|','.','+','.','.','.','.','.','+','.','|'}, {'|','.','.','`','.','.','.','.','.','|',' ',' ',' ',' ',' ','|','-','|','.','.','.','.','.','|','-','-'}, {'|','.','.','.','.','.','.','.','.','|',' ',' ',' ',' ',' ','|','.','+','.','.','.','.','.','|', ' ', ' '}, {'|','.','.','.','-','-','-','-','-','-',' ',' ',' ',' ',' ','-','-','|','.','.','.','.','.','|', ' ', ' '}, {'-','-','-','-','-',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ',' ','-','-','-','-','-','-','-', ' ', ' '}};

int cur_x, cur_y;
int level_no;
int max_level = 0;
char prev_sq = '>';
string msg = "";

void exit_msg() {
	cout << "You completed " << max_level << " levels! Yay good job have a nice day!";
}

void print_level(int level) {
	system("clear");
	for (int i=0; i<x_length; i++) {
		for (int j=0; j<y_length; j++) cout << cur_level[i][j];
		cout << "\n\r";
	}
}

void load_level(int level, bool up=true) {
	level_no = level;
	if (up) prev_sq = '>';
	else prev_sq = '<';
	switch(level) {
		case 1:
		x_length = 12; y_length = 16;
		if (up) {cur_x = 1; cur_y = 3;}
		else {cur_x = 1; cur_y = 1;}
		for (int i=0; i<x_length; i++) {
			for (int j=0; j<y_length; j++) cur_level[i][j] = level1[i][j];
		}
		msg = "Welcome to Sokoban! This is the first level. Have fun!";
		break;
		case 2:
		x_length = 14; y_length = 15;
		if (up) {cur_x = 4; cur_y = 6;}
		else {cur_x = 6; cur_y = 6;}
		for (int i=0; i<x_length; i++) {
			for (int j=0; j<y_length; j++) cur_level[i][j] = level2[i][j];
		}
		msg = "Second level!";
		break;
		case 3:
		x_length = 15; y_length = 27;
		if (up) {cur_x = 1; cur_y = 3;}
		else {cur_x = 4; cur_y = 20;}
		for (int i=0; i<x_length; i++) {
			for (int j=0; j<y_length; j++) cur_level[i][j] = level3[i][j];
		}
		msg = "Third level!";
		break;
		case 4:
		x_length = 13; y_length = 30;
		if (up) {cur_x = 2; cur_y = 11;}
		else {cur_x = 4; cur_y = 23;}
		for (int i=0; i<x_length; i++) {
			for (int j=0; j<y_length; j++) cur_level[i][j] = level4[i][j];
		}
		msg = "Fourth level!";
		break;
		case 5:
		x_length = 13; y_length = 21;
		if (up) {cur_x = 10; cur_y = 6;}
		else {cur_x = 4; cur_y = 16;}
		for (int i=0; i<x_length; i++) {
			for (int j=0; j<y_length; j++) cur_level[i][j] = level5[i][j];
		}
		msg = "Fifth level!";
		break;
		case 6:
		x_length = 19; y_length = 27;
		cur_x = 1; cur_y = 1;
		for (int i=0; i<x_length; i++) {
			for (int j=0; j<y_length; j++) cur_level[i][j] = level6[i][j];
		}
		msg = "Sixth (and final) level!";
		break;
	}
	cur_level[cur_x][cur_y] = '@';
	print_level(level);
}

void move_right() {
	if (cur_level[cur_x][cur_y+1] == '.' || cur_level[cur_x][cur_y+1] == '+' || cur_level[cur_x][cur_y+1] == '>' || cur_level[cur_x][cur_y+1] == '<' || (cur_level[cur_x][cur_y+1] == '`' && (cur_level[cur_x][cur_y+2] == '.' || cur_level[cur_x][cur_y+2] == '^'))) {
		if (cur_level[cur_x][cur_y+1] == '`' && cur_level[cur_x][cur_y+2] == '.') {
			cur_level[cur_x][cur_y+1] = '.';
			cur_level[cur_x][cur_y+2] = '`';
		}
		if (cur_level[cur_x][cur_y+1] == '`' && cur_level[cur_x][cur_y+2] == '^') {
			cur_level[cur_x][cur_y+1] = '.';
			cur_level[cur_x][cur_y+2] = '.';
			msg = "The boulder falls into the pit!";
			if (level_no == 6) {
				final_level--;
				if (!final_level) {
					max_level = 6;
					exit_msg();
					system("stty cooked");
					exit(0);
				}
			}
		}
		cur_level[cur_x][cur_y] = prev_sq;
		prev_sq = cur_level[cur_x][cur_y+1];
		cur_level[cur_x][cur_y+1] = '@';
		cur_y++;
		print_level(level_no);
	}
}

void move_left() {
	if (cur_level[cur_x][cur_y-1] == '.' || cur_level[cur_x][cur_y-1] == '+' || cur_level[cur_x][cur_y-1] == '>' || cur_level[cur_x][cur_y-1] == '<' || (cur_level[cur_x][cur_y-1] == '`' && (cur_level[cur_x][cur_y-2] == '.' || cur_level[cur_x][cur_y-2] == '^'))) {
		if (cur_level[cur_x][cur_y-1] == '`' && cur_level[cur_x][cur_y-2] == '.') {
			cur_level[cur_x][cur_y-1] = '.';
			cur_level[cur_x][cur_y-2] = '`';
		}
		if (cur_level[cur_x][cur_y-1] == '`' && cur_level[cur_x][cur_y-2] == '^') {
			cur_level[cur_x][cur_y-1] = '.';
			cur_level[cur_x][cur_y-2] = '.';
			msg = "The boulder falls into the pit!";
		}
		cur_level[cur_x][cur_y] = prev_sq;
		prev_sq = cur_level[cur_x][cur_y-1];
		cur_level[cur_x][cur_y-1] = '@';
		cur_y -= 1;
		print_level(level_no);
	}
}

void move_up() {
	if (cur_level[cur_x-1][cur_y] == '.' || cur_level[cur_x-1][cur_y] == '+' || cur_level[cur_x-1][cur_y] == '>' || cur_level[cur_x-1][cur_y] == '<' || (cur_level[cur_x-1][cur_y] == '`' && (cur_level[cur_x-2][cur_y] == '.' || cur_level[cur_x-2][cur_y] == '^'))) {
		if (cur_level[cur_x-1][cur_y] == '`' && cur_level[cur_x-2][cur_y] == '.') {
			cur_level[cur_x-1][cur_y] = '.';
			cur_level[cur_x-2][cur_y] = '`';
		}
		if (cur_level[cur_x-1][cur_y] == '`' && cur_level[cur_x-2][cur_y] == '^') {
			cur_level[cur_x-1][cur_y] = '.';
			cur_level[cur_x-2][cur_y] = '.';
			msg = "The boulder falls into the pit!";
		}
		cur_level[cur_x][cur_y] = prev_sq;
		prev_sq = cur_level[cur_x-1][cur_y];
		cur_level[cur_x-1][cur_y] = '@';
		cur_x -= 1;
		print_level(level_no);
	}
}

void move_down() {
	if (cur_level[cur_x+1][cur_y] == '.' || cur_level[cur_x+1][cur_y] == '+' || cur_level[cur_x+1][cur_y] == '>' || cur_level[cur_x+1][cur_y] == '<' || (cur_level[cur_x+1][cur_y] == '`' && (cur_level[cur_x+2][cur_y] == '.' || cur_level[cur_x+2][cur_y] == '^'))) {
		if (cur_level[cur_x+1][cur_y] == '`' && cur_level[cur_x+2][cur_y] == '.') {
			cur_level[cur_x+1][cur_y] = '.';
			cur_level[cur_x+2][cur_y] = '`';
		}
		if (cur_level[cur_x+1][cur_y] == '`' && cur_level[cur_x+2][cur_y] == '^') {
			cur_level[cur_x+1][cur_y] = '.';
			cur_level[cur_x+2][cur_y] = '.';
			msg = "The boulder falls into the pit!";
		}
		cur_level[cur_x][cur_y] = prev_sq;
		prev_sq = cur_level[cur_x+1][cur_y];
		cur_level[cur_x+1][cur_y] = '@';
		cur_x += 1;
		print_level(level_no);
	}
}

void level_up() {
	if (prev_sq == '<') {
		for (int i=0; i<x_length; i++) {
			for (int j=0; j<y_length; j++) {
				switch (level_no) {
					case 1:
					level1[i][j] = cur_level[i][j];
					break;
					case 2:
					level2[i][j] = cur_level[i][j];
					break;
					case 3:
					level3[i][j] = cur_level[i][j];
					break;
					case 4:
					level4[i][j] = cur_level[i][j];
					break;
					case 5:
					level5[i][j] = cur_level[i][j];
					break;
					case 6:
					level6[i][j] = cur_level[i][j];
					break;
				}
			}
		}
		max_level = max(max_level, level_no);
		level_no += 1;
		load_level(level_no);
	}
}

void level_down() {
	if (prev_sq == '>') {
		for (int i=0; i<x_length; i++) {
			for (int j=0; j<y_length; j++) {
				switch (level_no) {
					case 1:
					level1[i][j] = cur_level[i][j];
					break;
					case 2:
					level2[i][j] = cur_level[i][j];
					break;
					case 3:
					level3[i][j] = cur_level[i][j];
					break;
					case 4:
					level4[i][j] = cur_level[i][j];
					break;
					case 5:
					level5[i][j] = cur_level[i][j];
					break;
					case 6:
					level6[i][j] = cur_level[i][j];
					break;
				}
			}
		}
		level_no -= 1;
		if (level_no == 0) {
			exit_msg();
			system("stty cooked");
			exit(0);
		}
		load_level(level_no, false);
	}
}

void get_input() {
	msg = "";
	char x = getchar();
	if (x == 'h') move_left();
	else if (x == 'j') move_down();
	else if (x == 'k') move_up();
	else if (x == 'l') move_right();
	else if (x == '>') level_down();
	else if (x == '<') level_up();
	else if (x == 'q') {
		exit_msg();
		system("stty cooked");
		exit(0);
	}
	if (msg != "") cout << msg << '\n';
}